<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEON SHOP ‚Äî –í–∏—Ç—Ä–∏–Ω–∞</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --preorder: #f59e0b; /* –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –ø—Ä–µ–¥–∑–∞–∫–∞–∑–∞ */
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text: #1e293b;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-gradient);
            margin: 0; padding: 20px 10px 120px 10px;
            color: var(--text);
        }

        .container { max-width: 450px; margin: 0 auto; }
        h2 { text-align: center; font-weight: 800; color: var(--primary); }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .product-card {
            background: white; border-radius: 24px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .product-icon { font-size: 42px; margin-bottom: 8px; }
        .product-name { font-weight: 700; font-size: 14px; text-align: center; height: 36px; margin-bottom: 4px; overflow: hidden; }

        /* –ú–µ—Ç–∫–∏ –Ω–∞–ª–∏—á–∏—è */
        .stock-tag {
            font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-bottom: 10px;
        }
        .in-stock { background: #ecfdf5; color: #059669; }
        .is-preorder { background: #fffbeb; color: #d97706; }

        .product-price { font-weight: 800; font-size: 18px; margin-bottom: 12px; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-action { width: 100%; border: none; padding: 12px; border-radius: 14px; font-weight: 700; cursor: pointer; transition: 0.2s; color: white; }
        .buy-mode { background: var(--primary); }
        .preorder-mode { background: var(--preorder); }

        .stepper { display: flex; justify-content: space-between; align-items: center; width: 100%; background: #f1f5f9; border-radius: 14px; padding: 4px; box-sizing: border-box; }
        .btn-step { background: white; border: none; width: 32px; height: 32px; border-radius: 10px; font-weight: bold; cursor: pointer; color: var(--primary); }

        /* –ö–æ—Ä–∑–∏–Ω–∞ Bar */
        .cart-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
            border-radius: 24px 24px 0 0; z-index: 1000;
            transition: all 0.4s ease; max-height: 75px; overflow: hidden;
        }
        .cart-bar.expanded { max-height: 85vh; overflow-y: auto; }
        .cart-header { height: 75px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; cursor: pointer; }
        .cart-summary b { font-size: 18px; display: block; }
        .btn-open-cart { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 14px; font-weight: 800; }

        .cart-content { padding: 0 20px 30px 20px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f1f5f9; }
        .item-preorder-label { font-size: 10px; background: #fffbeb; color: #d97706; padding: 2px 4px; border-radius: 4px; margin-left: 5px; }

        .form-block { margin-top: 20px; display: grid; gap: 10px; }
        .form-block input { padding: 16px; border-radius: 14px; border: 1px solid #e2e8f0; font-size: 16px; outline: none; }
        .btn-final { background: #22c55e; color: white; border: none; padding: 18px; border-radius: 16px; font-weight: 800; font-size: 18px; cursor: pointer; }
        
        .drag-line { width: 40px; height: 4px; background: #e2e8f0; border-radius: 2px; margin: 10px auto 5px auto; }
    </style>
</head>
<body>

<div class="container">
    <h2>üõç NEON SHOP</h2>
    <div id="catalog" class="products-grid"></div>
</div>

<div class="cart-bar" id="cart-bar" style="display: none;">
    <div class="drag-line"></div>
    <div class="cart-header" onclick="toggleCart()">
        <div class="cart-summary"><b id="bar-total">0 ‚ÇΩ</b><span id="bar-count" style="font-size:12px; color:#64748b;">0 —Ç–æ–≤–∞—Ä–æ–≤</span></div>
        <button class="btn-open-cart" id="main-cart-btn">–û–§–û–†–ú–ò–¢–¨</button>
    </div>
    <div class="cart-content">
        <h3 style="margin: 10px 0;">–í–∞—à —Å–ø–∏—Å–æ–∫:</h3>
        <div id="cart-items"></div>
        <div class="form-block">
            <input type="text" id="userName" placeholder="üë§ –í–∞—à–µ –∏–º—è">
            <input type="tel" id="userPhone" placeholder="üìû –¢–µ–ª–µ—Ñ–æ–Ω">
            <button class="btn-final" onclick="sendOrder()">–ó–ê–ö–ê–ó–ê–¢–¨</button>
        </div>
    </div>
</div>

<script>
    // –¢–≤–æ–π –∫–æ–Ω—Ñ–∏–≥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const firebaseConfig = {
        apiKey: "AIzaSyBH0g83qEUERiDBjgMgRnSJ-s2lvpPtkz4",
        authDomain: "vitrina-e0a00.firebaseapp.com",
        databaseURL: "https://vitrina-e0a00-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "vitrina-e0a00",
        storageBucket: "vitrina-e0a00.firebasestorage.app",
        messagingSenderId: "182787477088",
        appId: "1:182787477088:web:35827926e1e885bb0bfd05"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let products = [];
    let cart = [];

    database.ref('skladData/products').on('value', (snapshot) => {
        products = snapshot.val() || [];
        renderCatalog();
    });

    function renderCatalog() {
        const catalog = document.getElementById('catalog');
        const visible = products.filter(p => p.hidden !== true);

        catalog.innerHTML = visible.map(p => {
            const stock = (p.history || []).reduce((s, h) => s + h.qty, 0);
            const inCart = cart.find(i => i.id === p.id);
            
            const isAvailable = stock > 0;
            const tagClass = isAvailable ? 'stock-tag in-stock' : 'stock-tag is-preorder';
            const tagText = isAvailable ? `–í –Ω–∞–ª–∏—á–∏–∏: ${stock} —à—Ç` : `–ü–æ–¥ –∑–∞–∫–∞–∑`;

            let actionBtn = '';
            if (!inCart) {
                const btnClass = isAvailable ? 'btn-action buy-mode' : 'btn-action preorder-mode';
                const btnText = isAvailable ? '–ö—É–ø–∏—Ç—å' : '–ü—Ä–µ–¥–∑–∞–∫–∞–∑';
                actionBtn = `<button class="${btnClass}" onclick="updateQty(${p.id}, 1)">${btnText}</button>`;
            } else {
                actionBtn = `
                    <div class="stepper">
                        <button class="btn-step" onclick="updateQty(${p.id}, -1)">-</button>
                        <span style="font-weight:800">${inCart.qty}</span>
                        <button class="btn-step" onclick="updateQty(${p.id}, 1)">+</button>
                    </div>`;
            }

            return `
                <div class="product-card">
                    <div class="product-icon">${p.icon || 'üì¶'}</div>
                    <div class="product-name">${p.name}</div>
                    <div class="${tagClass}">${tagText}</div>
                    <div class="product-price">${p.price} ‚ÇΩ</div>
                    ${actionBtn}
                </div>
            `;
        }).join('');
    }

    function updateQty(pId, delta) {
        const product = products.find(p => p.id === pId);
        const existing = cart.find(i => i.id === pId);
        const stock = (product.history || []).reduce((s, h) => s + h.qty, 0);

        if (existing) {
            existing.qty += delta;
            if (existing.qty <= 0) cart = cart.filter(i => i.id !== pId);
        } else if (delta > 0) {
            cart.push({ 
                id: product.id, 
                name: product.name, 
                price: product.price, 
                qty: 1,
                isPreorder: stock <= 0 // –ü–æ–º–µ—á–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –ø—Ä–µ–¥–∑–∞–∫–∞–∑
            });
        }
        renderCatalog();
        updateCartBar();
    }

    function updateCartBar() {
        const bar = document.getElementById('cart-bar');
        const itemsList = document.getElementById('cart-items');
        if (cart.length === 0) { bar.style.display = 'none'; bar.classList.remove('expanded'); return; }

        bar.style.display = 'block';
        let total = 0, count = 0;

        itemsList.innerHTML = cart.map(item => {
            total += item.price * item.qty;
            count += item.qty;
            return `
                <div class="cart-item">
                    <div>
                        <span>${item.name} <b>x${item.qty}</b></span>
                        ${item.isPreorder ? '<span class="item-preorder-label">–ü–†–ï–î–ó–ê–ö–ê–ó</span>' : ''}
                    </div>
                    <b>${item.price * item.qty} ‚ÇΩ</b>
                </div>
            `;
        }).join('');

        document.getElementById('bar-total').innerText = total + ' ‚ÇΩ';
        document.getElementById('bar-count').innerText = count + ' —Ç–æ–≤.';
    }

    function toggleCart() {
        const bar = document.getElementById('cart-bar');
        bar.classList.toggle('expanded');
        document.getElementById('main-cart-btn').innerText = bar.classList.contains('expanded') ? "–ó–ê–ö–†–´–¢–¨" : "–û–§–û–†–ú–ò–¢–¨";
    }

    function sendOrder() {
        const name = document.getElementById('userName').value;
        const phone = document.getElementById('userPhone').value;
        if (!name || !phone) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ —Ç–µ–ª–µ—Ñ–æ–Ω!");

        const order = {
            id: Date.now(),
            clientName: `${name} (${phone})`,
            date: new Date().toLocaleString(),
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–º–µ—Ç–∫—É "(–ü–†–ï–î–ó–ê–ö–ê–ó)" –∫ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞ –≤ –±–∞–∑–µ, —á—Ç–æ–±—ã —Ç—ã —Å—Ä–∞–∑—É –≤–∏–¥–µ–ª
            items: cart.map(i => ({ 
                name: i.isPreorder ? i.name + " (–ü–†–ï–î–ó–ê–ö–ê–ó)" : i.name, 
                qty: i.qty 
            }))
        };

        database.ref('skladData/incomingOrders').get().then(snap => {
            let orders = snap.val() || [];
            orders.push(order);
            database.ref('skladData/incomingOrders').set(orders).then(() => {
                alert("‚úÖ –ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –ï—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ –µ—Å—Ç—å –ø—Ä–µ–¥–∑–∞–∫–∞–∑—ã, –º—ã —Å–æ–æ–±—â–∏–º –æ —Å—Ä–æ–∫–∞—Ö.");
                cart = [];
                updateCartBar();
                renderCatalog();
                document.getElementById('userName').value = '';
                document.getElementById('userPhone').value = '';
            });
        });
    }
</script>
</body>
</html>
